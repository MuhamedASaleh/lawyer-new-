<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call App</title>
</head>
<body>
    <h1>Video Call Application</h1>

    <div>
        <label for="username">Enter Username:</label>
        <input type="text" id="username" required>
        <button id="joinButton">Join</button>
    </div>

    <div id="userListContainer">
        <h2>Online Users</h2>
        <ul id="userList"></ul>
    </div>

    <div id="callControls" style="display: none;">
        <label for="calleeUsername">Calling User ID:</label>
        <input type="text" id="calleeUsername" readonly>
        <button id="startCallButton">Start Call</button>
    </div>

    <div id="incomingCall" style="display: none;">
        <h3 id="callerName"></h3>
        <button id="acceptCall">Accept</button>
        <button id="rejectCall">Reject</button>
    </div>

    <h2>Local Video</h2>
    <video id="localVideo" autoplay playsinline style="width: 50%;"></video>

    <h2>Remote Video</h2>
    <video id="remoteVideo" autoplay playsinline style="width: 50%;"></video>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const usernameInput = document.getElementById('username');
        const joinButton = document.getElementById('joinButton');
        const userList = document.getElementById('userList');
        const callControls = document.getElementById('callControls');
        const startCallButton = document.getElementById('startCallButton');
        const incomingCallDiv = document.getElementById('incomingCall');
        const callerNameElem = document.getElementById('callerName');
        const acceptCallButton = document.getElementById('acceptCall');
        const rejectCallButton = document.getElementById('rejectCall');
        const calleeUsernameInput = document.getElementById('calleeUsername');

        let localStream;
        let peerConnection;
        const servers = null; // Use default STUN/TURN servers
        let roomId;
        let callerSocketId;

        joinButton.onclick = () => {
            const username = usernameInput.value;
            if (username) {
                socket.emit('join', username);
            }
        };

        startCallButton.onclick = () => {
            const calleeSocketId = calleeUsernameInput.value;
            if (calleeSocketId) {
                socket.emit('startCall', calleeSocketId);
            }
        };

        socket.on('updateUserList', (users) => {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user.name;
                const callButton = document.createElement('button');
                callButton.textContent = 'Call';
                callButton.onclick = () => {
                    calleeUsernameInput.value = user.id;
                    callControls.style.display = 'block';
                };
                li.appendChild(callButton);
                userList.appendChild(li);
            });
        });

        socket.on('incomingCall', ({ caller, callerSocketId }) => {
            callerNameElem.textContent = `Incoming call from ${caller}`;
            incomingCallDiv.style.display = 'block';
            this.callerSocketId = callerSocketId;
        });

        acceptCallButton.onclick = async () => {
            incomingCallDiv.style.display = 'none';
            await startLocalStream();
            socket.emit('acceptCall', { callerSocketId });
            setupPeerConnection();
            localStream.getTracks().forEach(track => {
                if (!peerConnection.getSenders().some(sender => sender.track === track)) {
                    peerConnection.addTrack(track, localStream);
                }
            });
        };

        rejectCallButton.onclick = () => {
            incomingCallDiv.style.display = 'none';
        };

        socket.on('callAccepted', ({ roomId }) => {
            this.roomId = roomId;
            setupPeerConnection();
        });

        socket.on('offer', async (offer) => {
            setupPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', answer, roomId);
        });

        socket.on('answer', async (answer) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on('ice candidate', async (candidate) => {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
                console.error('Error adding received ICE candidate', e);
            }
        });

        async function setupPeerConnection() {
            if (!peerConnection) {
                peerConnection = new RTCPeerConnection(servers);
                peerConnection.ontrack = (event) => {
                    remoteVideo.srcObject = event.streams[0];
                };
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice candidate', event.candidate, roomId);
                    }
                };
            }
        }

        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }
        }
    </script>
</body>
</html>
