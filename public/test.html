<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #f0f0f0;
        }

        #userList {
            margin-bottom: 20px;
        }

        #callControls, #incomingCall {
            margin-top: 20px;
        }

        #localVideo, #remoteVideo {
            width: 200px;
            height: 150px;
            border: 2px solid #ccc;
            background-color: #000;
        }

        #videoContainer {
            position: relative;
            width: 80%;
            height: 80vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #000;
        }

        #remoteVideo {
            width: 100%;
            height: 100%;
        }

        #localVideo {
            position: absolute;
            bottom: 20px;
            right: 20px;
        }
    </style>
</head>
<body>
    <h1>Video Call App</h1>
    <input id="username" placeholder="Enter your username" />
    <button id="joinButton">Join</button>

    <h2>Online Users</h2>
    <ul id="userList"></ul>

    <div id="callControls" style="display: none;">
        <input type="hidden" id="calleeSocketId" />
        <button id="startCallButton">Start Call</button>
    </div>

    <div id="incomingCall" style="display: none;">
        <p id="callerName"></p>
        <button id="acceptCall">Accept</button>
        <button id="rejectCall">Reject</button>
    </div>

    <div id="videoContainer">
        <video id="remoteVideo" autoplay></video>
        <video id="localVideo" autoplay muted></video>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const localVideo = document.getElementById('localVideo');
        const remoteVideo = document.getElementById('remoteVideo');
        const usernameInput = document.getElementById('username');
        const joinButton = document.getElementById('joinButton');
        const userList = document.getElementById('userList');
        const callControls = document.getElementById('callControls');
        const startCallButton = document.getElementById('startCallButton');
        const incomingCallDiv = document.getElementById('incomingCall');
        const callerNameElem = document.getElementById('callerName');
        const acceptCallButton = document.getElementById('acceptCall');
        const rejectCallButton = document.getElementById('rejectCall');
        const calleeSocketIdInput = document.getElementById('calleeSocketId');

        let localStream;
        let remoteStream;
        let peerConnection;
        const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }; // Using a Google STUN server
        let roomId;
        let callerSocketId;

        joinButton.onclick = async () => {
            const username = usernameInput.value;
            if (username) {
                socket.emit('join', username);
                await startLocalStream(); // Start local stream when joining
            }
        };

        startCallButton.onclick = async () => {
            const calleeSocketId = calleeSocketIdInput.value;
            if (calleeSocketId) {
                await startLocalStream(); // Ensure the local stream starts before creating an offer
                socket.emit('startCall', calleeSocketId);
            }
        };

        socket.on('updateUserList', (users) => {
            userList.innerHTML = '';
            users.forEach(user => {
                const li = document.createElement('li');
                li.textContent = user.name;
                const callButton = document.createElement('button');
                callButton.textContent = 'Call';
                callButton.onclick = () => {
                    calleeSocketIdInput.value = user.id;
                    callControls.style.display = 'block';
                };
                li.appendChild(callButton);
                userList.appendChild(li);
            });
        });

        socket.on('incomingCall', ({ caller, callerSocketId: callerId }) => {
            callerNameElem.textContent = `Incoming call from ${caller}`;
            incomingCallDiv.style.display = 'block';
            callerSocketId = callerId;
        });

        acceptCallButton.onclick = async () => {
            incomingCallDiv.style.display = 'none';
            await startLocalStream(); // Start the local stream for the callee
            socket.emit('acceptCall', { callerSocketId });
            setupPeerConnection();
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
        };

        rejectCallButton.onclick = () => {
            incomingCallDiv.style.display = 'none';
        };

        socket.on('callAccepted', async ({ roomId: id }) => {
            roomId = id; // Set roomId for later use
            setupPeerConnection();
            
            // Caller creates an offer after the call is accepted
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('offer', offer, roomId);
        });

        socket.on('offer', async (offer) => {
            setupPeerConnection();
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer', answer, roomId);
        });

        socket.on('answer', async (answer) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        });

        socket.on('ice candidate', async (candidate) => {
            try {
                await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
            } catch (e) {
                console.error('Error adding received ICE candidate', e);
            }
        });

        async function setupPeerConnection() {
            peerConnection = new RTCPeerConnection(servers);

            // Create a new MediaStream for the remote video
            remoteStream = new MediaStream();
            remoteVideo.srcObject = remoteStream;

            peerConnection.ontrack = (event) => {
                // Add tracks from the peer connection to the remote stream
                event.streams[0].getTracks().forEach(track => {
                    remoteStream.addTrack(track);
                });
            };

            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    socket.emit('ice candidate', event.candidate, roomId);
                }
            };

            // Add local tracks to the peer connection
            if (localStream) {
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
            }
        }

        async function startLocalStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (error) {
                console.error('Error accessing media devices.', error);
            }
        }
    </script>
</body>
</html>
