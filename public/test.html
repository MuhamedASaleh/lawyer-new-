<!-- 
 <!DOCTYPE html>
 <html>
 <head>
     <title>Voice and Video Call with WebRTC and Socket.io</title>
 </head>
 <body>
     <h1>Voice and Video Call</h1>
     <button id="startVoiceCall">Start Voice Call</button>
     <button id="startVideoCall">Start Video Call</button>
     <button id="endCall" style="display:none;">End Call</button>
     <audio id="remoteAudio" autoplay></audio>
     <video id="localVideo" autoplay muted style="width: 300px; height: 300px; display:none;"></video>
     <video id="remoteVideo" autoplay style="width: 300px; height: 300px; display:none;"></video>
     <div id="callNotification" style="display:none;">
         <p>Incoming call from <span id="callerName"></span></p>
         <button id="acceptCall">Accept</button>
         <button id="rejectCall">Reject</button>
     </div>
     <div id="endCallNotification" style="display:none;">
         <p>The call has ended.</p>
     </div>
     <script src="/socket.io/socket.io.js"></script>
     <script>
         const socket = io();
 
         const startVoiceCallButton = document.getElementById('startVoiceCall');
         const startVideoCallButton = document.getElementById('startVideoCall');
         const endCallButton = document.getElementById('endCall');
         const remoteAudio = document.getElementById('remoteAudio');
         const localVideo = document.getElementById('localVideo');
         const remoteVideo = document.getElementById('remoteVideo');
         const callNotification = document.getElementById('callNotification');
         const callerName = document.getElementById('callerName');
         const acceptCallButton = document.getElementById('acceptCall');
         const rejectCallButton = document.getElementById('rejectCall');
         const endCallNotification = document.getElementById('endCallNotification');
 
         let localStream;
         let peerConnection;
         let remoteUserId;
         let isVideoCall = false;
 
         const configuration = {
             iceServers: [
                 { urls: 'stun:stun.l.google.com:19302' }
             ]
         };
 
         async function startCall(video) {
             try {
                 localStream = await navigator.mediaDevices.getUserMedia({ video: video, audio: true });
                 if (video) {
                     localVideo.srcObject = localStream;
                     localVideo.style.display = 'block';
                 } else {
                     remoteAudio.srcObject = localStream;
                 }
 
                 peerConnection = new RTCPeerConnection(configuration);
 
                 localStream.getTracks().forEach(track => {
                     peerConnection.addTrack(track, localStream);
                 });
 
                 peerConnection.onicecandidate = event => {
                     if (event.candidate) {
                         socket.emit('candidate', {
                             candidate: event.candidate.toJSON(),
                             target: remoteUserId
                         });
                     }
                 };
 
                 peerConnection.ontrack = event => {
                     if (event.track.kind === 'video') {
                         remoteVideo.srcObject = event.streams[0];
                         remoteVideo.style.display = 'block';
                     } else {
                         remoteAudio.srcObject = event.streams[0];
                     }
                 };
 
                 const offer = await peerConnection.createOffer();
                 await peerConnection.setLocalDescription(offer);
 
                 socket.emit('offer', {
                     sdp: peerConnection.localDescription,
                     target: remoteUserId,
                     video: video
                 });
 
                 // Show end call button and hide start call buttons
                 startVoiceCallButton.style.display = 'none';
                 startVideoCallButton.style.display = 'none';
                 endCallButton.style.display = 'block';
                 isVideoCall = video;
             } catch (error) {
                 console.error('Error starting call:', error);
             }
         }
 
         startVoiceCallButton.onclick = () => startCall(false);
         startVideoCallButton.onclick = () => startCall(true);
         socket.on('incomingCall', async data => {
             // Set the remote user ID
             remoteUserId = data.caller;
             isVideoCall = data.video;
 
             // Show call notification
             callNotification.style.display = 'block';
             callerName.textContent = remoteUserId;
 
             // Handle call acceptance
             acceptCallButton.onclick = async () => {
                 callNotification.style.display = 'none';
 
                 try {
                     peerConnection = new RTCPeerConnection(configuration);
 
                     peerConnection.onicecandidate = event => {
                         if (event.candidate) {
                             socket.emit('candidate', {
                                 candidate: event.candidate.toJSON(),
                                 target: remoteUserId
                             });
                         }
                     };
 
                     peerConnection.ontrack = event => {
                         if (event.track.kind === 'video') {
                             remoteVideo.srcObject = event.streams[0];
                             remoteVideo.style.display = 'block';
                         } else {
                             remoteAudio.srcObject = event.streams[0];
                         }
                     };
 
                     localStream = await navigator.mediaDevices.getUserMedia({ video: isVideoCall, audio: true });
                     if (isVideoCall) {
                         localVideo.srcObject = localStream;
                         localVideo.style.display = 'block';
                     } else {
                         remoteAudio.srcObject = localStream;
                     }
 
                     localStream.getTracks().forEach(track => {
                         peerConnection.addTrack(track, localStream);
                     });
 
                     await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
 
                     const answer = await peerConnection.createAnswer();
                     await peerConnection.setLocalDescription(answer);
 
                     socket.emit('answer', {
                         sdp: peerConnection.localDescription,
                         target: remoteUserId
                     });
 
                     // Show end call button and hide start call buttons
                     startVoiceCallButton.style.display = 'none';
                     startVideoCallButton.style.display = 'none';
                     endCallButton.style.display = 'block';
                 } catch (error) {
                     console.error('Error accepting call:', error);
                 }
             };
 
             // Handle call rejection
             rejectCallButton.onclick = () => {
                 callNotification.style.display = 'none';
             };
         });
 
         socket.on('answer', async data => {
             try {
                 await peerConnection.setRemoteDescription(new RTCSessionDescription(data.sdp));
             } catch (error) {
                 console.error('Error handling answer:', error);
             }
         });
 
         socket.on('candidate', async data => {
             try {
                 const candidate = new RTCIceCandidate(data.candidate);
                 await peerConnection.addIceCandidate(candidate);
             } catch (error) {
                 console.error('Error adding received ICE candidate:', error);
             }
         });
 
         endCallButton.onclick = () => {
             if (peerConnection) {
                 peerConnection.close();
                 peerConnection = null;
                 socket.emit('endCall', { target: remoteUserId });
                 startVoiceCallButton.style.display = 'block';
                 startVideoCallButton.style.display = 'block';
                 endCallButton.style.display = 'none';
                 localVideo.style.display = 'none';
                 remoteVideo.style.display = 'none';
             }
         };
 
         // Listen for call end notifications
         socket.on('endCallNotification', () => {
             endCallNotification.style.display = 'block';
             setTimeout(() => {
                 endCallNotification.style.display = 'none';
             }, 3000); // Hide notification after 3 seconds
             startVoiceCallButton.style.display = 'block';
             startVideoCallButton.style.display = 'block';
             endCallButton.style.display = 'none';
             localVideo.style.display = 'none';
             remoteVideo.style.display = 'none';
         });
 
         // Emit a signal to notify when a new user connects
         socket.emit('new-user', { userId: socket.id });
 
         // Listen for new users to set remote user ID
         socket.on('new-user', data => {
             if (!remoteUserId) {
                 remoteUserId = data.userId;
             }
         });
     </script>
 </body>
 </html>
   -->
   <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Socket.io Video Call Test</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
    }
    #video-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }
    video {
      width: 300px;
      height: 200px;
      border: 1px solid #ddd;
      margin: 10px;
    }
  </style>
</head>
<body>
  <div id="video-container">
    <h1>Video Call Test</h1>
    <video id="local-video" autoplay muted></video>
    <video id="remote-video" autoplay></video>
    <button id="start-call">Start Call</button>
    <button id="end-call" disabled>End Call</button>
    <button id="accept-call" disabled>Accept Call</button>
    <button id="decline-call" disabled>Decline Call</button>
  </div>

  <script>
    const socket = io();
    let localStream;
    let peerConnection;
    const configuration = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

    const localVideo = document.getElementById('local-video');
    const remoteVideo = document.getElementById('remote-video');
    const startCallButton = document.getElementById('start-call');
    const endCallButton = document.getElementById('end-call');
    const acceptCallButton = document.getElementById('accept-call');
    const declineCallButton = document.getElementById('decline-call');

    async function initLocalStream() {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        localVideo.srcObject = localStream;
      } catch (err) {
        console.error('Error accessing media devices.', err);
      }
    }

    function handleNegotiationNeeded(event) {
      peerConnection.createOffer().then(offer => {
        return peerConnection.setLocalDescription(offer);
      }).then(() => {
        socket.emit('video call offer', peerConnection.localDescription);
      }).catch(err => console.error('Offer creation failed:', err));
    }

    function handleTrackEvent(event) {
      remoteVideo.srcObject = event.streams[0];
    }

    function handleIceCandidate(event) {
      if (event.candidate) {
        socket.emit('video call ice-candidate', event.candidate);
      }
    }

    function handleOffer(offer) {
      peerConnection = new RTCPeerConnection(configuration);
      peerConnection.ontrack = handleTrackEvent;
      peerConnection.onicecandidate = handleIceCandidate;
      peerConnection.addStream(localStream);

      peerConnection.setRemoteDescription(new RTCSessionDescription(offer)).then(() => {
        return peerConnection.createAnswer();
      }).then(answer => {
        return peerConnection.setLocalDescription(answer);
      }).then(() => {
        socket.emit('video call answer', peerConnection.localDescription);
      }).catch(err => console.error('Answer creation failed:', err));
    }

    function handleAnswer(answer) {
      peerConnection.setRemoteDescription(new RTCSessionDescription(answer)).catch(err => console.error('Failed to set remote description:', err));
    }

    function handleIceCandidate(iceCandidate) {
      peerConnection.addIceCandidate(new RTCIceCandidate(iceCandidate)).catch(err => console.error('Failed to add ice candidate:', err));
    }

    function handleCallEnd() {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
        remoteVideo.srcObject = null;
      }
    }

    startCallButton.addEventListener('click', () => {
      initLocalStream().then(() => {
        peerConnection = new RTCPeerConnection(configuration);
        peerConnection.ontrack = handleTrackEvent;
        peerConnection.onicecandidate = handleIceCandidate;
        peerConnection.addStream(localStream);

        peerConnection.createOffer().then(offer => {
          return peerConnection.setLocalDescription(offer);
        }).then(() => {
          socket.emit('start video call', { receiverId: 2 }); // Adjust receiverId accordingly
        }).catch(err => console.error('Offer creation failed:', err));

        startCallButton.disabled = true;
        endCallButton.disabled = false;
      });
    });

    endCallButton.addEventListener('click', () => {
      socket.emit('end video call', { roomId: '1-2' }); // Adjust roomId accordingly
      handleCallEnd();
      startCallButton.disabled = false;
      endCallButton.disabled = true;
    });

    acceptCallButton.addEventListener('click', () => {
      socket.emit('accept video call', { callerId: 1 }); // Adjust callerId accordingly
    });

    declineCallButton.addEventListener('click', () => {
      socket.emit('decline video call', { callerId: 1 }); // Adjust callerId accordingly
    });

    socket.on('video call offer', handleOffer);
    socket.on('video call answer', handleAnswer);
    socket.on('video call ice-candidate', handleIceCandidate);
    socket.on('video call accepted', () => {
      acceptCallButton.disabled = true;
      declineCallButton.disabled = true;
    });
    socket.on('video call declined', () => {
      acceptCallButton.disabled = true;
      declineCallButton.disabled = true;
    });
  </script>
</body>
</html>

